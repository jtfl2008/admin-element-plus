# 工具函数库

## Monorepo 包工具

项目使用 Monorepo 架构，将通用工具封装在 `packages/` 目录下。

### @sa/hooks - Vue 组合函数库

#### useBoolean - 布尔值管理

管理布尔状态的 Hook。

```typescript
import { useBoolean } from '@sa/hooks';

const { bool, setBool, setTrue, setFalse, toggle } = useBoolean(false);

// 使用
setTrue();  // 设置为 true
setFalse(); // 设置为 false
toggle();   // 切换状态
setBool(true); // 设置指定值
```

**返回值**:
- `bool`: 布尔值 ref
- `setBool(value)`: 设置布尔值
- `setTrue()`: 设置为 true
- `setFalse()`: 设置为 false
- `toggle()`: 切换状态

#### useLoading - 加载状态管理

管理加载状态的 Hook。

```typescript
import { useLoading } from '@sa/hooks';

const { loading, startLoading, endLoading } = useLoading(false);

async function fetchData() {
  startLoading();
  try {
    await api.getData();
  } finally {
    endLoading();
  }
}
```

**返回值**:
- `loading`: 加载状态 ref
- `startLoading()`: 开始加载
- `endLoading()`: 结束加载

#### useCountDown - 倒计时

倒计时 Hook。

```typescript
import { useCountDown } from '@sa/hooks';

const { count, start, stop, reset } = useCountDown(60);

// 开始倒计时
start();

// 停止倒计时
stop();

// 重置倒计时
reset();
```

**参数**:
- `initialCount`: 初始倒计时秒数

**返回值**:
- `count`: 当前倒计时值
- `start()`: 开始倒计时
- `stop()`: 停止倒计时
- `reset()`: 重置倒计时

#### useContext - 上下文管理

创建和使用上下文的 Hook。

```typescript
import { useContext } from '@sa/hooks';

// 创建上下文
const [provideMyContext, useMyContext] = useContext('MyContext', () => {
  const state = ref('value');
  
  function updateState(newValue: string) {
    state.value = newValue;
  }
  
  return {
    state,
    updateState
  };
});

// 在父组件中提供上下文
provideMyContext();

// 在子组件中使用上下文
const { state, updateState } = useMyContext();
```

#### useTable - 表格管理

表格数据管理 Hook。

```typescript
import { useTable } from '@sa/hooks';

const {
  data,
  loading,
  pagination,
  getData,
  handleQuery,
  handleReset
} = useTable({
  apiFn: fetchList,
  apiParams: {
    pageNum: 1,
    pageSize: 10
  },
  immediate: true
});
```

**参数**:
- `apiFn`: API 请求函数
- `apiParams`: API 请求参数
- `immediate`: 是否立即请求，默认 `false`

**返回值**:
- `data`: 表格数据
- `loading`: 加载状态
- `pagination`: 分页信息
- `getData()`: 获取数据
- `handleQuery(params)`: 查询数据
- `handleReset()`: 重置查询

#### useSvgIconRender - SVG 图标渲染

SVG 图标渲染 Hook。

```typescript
import { useSvgIconRender } from '@sa/hooks';

const { SvgIconVNode } = useSvgIconRender();

// 渲染图标
const icon = SvgIconVNode({ icon: 'menu-system', fontSize: 20 });
```

### @sa/utils - 通用工具函数库

#### 加密工具 (crypto)

```typescript
import { encrypt, decrypt, encryptBase64, decryptBase64 } from '@sa/utils';

// RSA 加密
const encrypted = encrypt('password');

// RSA 解密
const decrypted = decrypt(encrypted);

// Base64 加密
const base64Encrypted = encryptBase64('data');

// Base64 解密
const base64Decrypted = decryptBase64(base64Encrypted);
```

**函数列表**:
- `encrypt(text)`: RSA 加密
- `decrypt(text)`: RSA 解密
- `encryptBase64(text)`: Base64 加密
- `decryptBase64(text)`: Base64 解密

#### 存储工具 (storage)

```typescript
import { localStg, sessionStg } from '@sa/utils';

// localStorage 操作
localStg.set('key', 'value');
const value = localStg.get('key');
localStg.remove('key');
localStg.clear();

// sessionStorage 操作
sessionStg.set('key', 'value');
const sessionValue = sessionStg.get('key');
sessionStg.remove('key');
sessionStg.clear();
```

**方法**:
- `set(key, value)`: 设置值
- `get(key)`: 获取值
- `remove(key)`: 删除值
- `clear()`: 清空所有值

#### ID 生成 (nanoid)

```typescript
import { nanoid } from '@sa/utils';

// 生成唯一 ID
const id = nanoid();

// 生成指定长度的 ID
const customId = nanoid(10);
```

#### 深拷贝 (klona)

```typescript
import { klona } from '@sa/utils';

const original = { a: 1, b: { c: 2 } };
const cloned = klona(original);
```

### @sa/color - 颜色管理工具

```typescript
import { addColorAlpha, getColorPalette } from '@sa/color';

// 添加透明度
const colorWithAlpha = addColorAlpha('#0E42D2', 0.5);

// 生成调色板
const palette = getColorPalette('#0E42D2');
// 返回: ['#0E42D2-50', '#0E42D2-100', ..., '#0E42D2-900']
```

**函数列表**:
- `addColorAlpha(color, alpha)`: 添加透明度
- `getColorPalette(color)`: 生成调色板
- `isValidColor(color)`: 验证颜色格式

## 项目内工具函数

### 通用工具 (src/utils/common.ts)

#### transformRecordToOption - 记录转选项

将记录对象转换为选项数组。

```typescript
import { transformRecordToOption } from '@/utils/common';

const record = {
  '0': '正常',
  '1': '停用'
};

const options = transformRecordToOption(record);
// 返回: [{ label: '正常', value: '0' }, { label: '停用', value: '1' }]
```

#### getServiceBaseURL - 获取服务基础 URL

```typescript
import { getServiceBaseURL } from '@/utils/common';

const baseURL = getServiceBaseURL();
```

#### isNullOrWhitespace - 判断空字符串

```typescript
import { isNullOrWhitespace } from '@/utils/common';

isNullOrWhitespace('');      // true
isNullOrWhitespace('  ');    // true
isNullOrWhitespace('text');  // false
```

### 表单工具 (src/utils/form.ts)

#### getConfirmPwdRule - 确认密码规则

```typescript
import { getConfirmPwdRule } from '@/utils/form';

const rules = {
  password: [
    { required: true, message: '请输入密码' }
  ],
  confirmPassword: [
    { required: true, message: '请确认密码' },
    getConfirmPwdRule(formData.password)
  ]
};
```

#### getRequiredRule - 必填规则

```typescript
import { getRequiredRule } from '@/utils/form';

const rules = {
  username: [
    getRequiredRule('请输入用户名')
  ]
};
```

#### getEmailRule - 邮箱规则

```typescript
import { getEmailRule } from '@/utils/form';

const rules = {
  email: [
    getEmailRule('请输入正确的邮箱地址')
  ]
};
```

#### getPhoneRule - 手机号规则

```typescript
import { getPhoneRule } from '@/utils/form';

const rules = {
  phone: [
    getPhoneRule('请输入正确的手机号')
  ]
};
```

### 路由工具 (src/utils/router.ts)

#### getRoutePath - 获取路由路径

```typescript
import { getRoutePath } from '@/utils/router';

const path = getRoutePath('system_user');
// 返回: '/system/user'
```

#### getRouteQuery - 获取路由查询参数

```typescript
import { getRouteQuery } from '@/utils/router';

const query = getRouteQuery(route);
```

#### isRouteExist - 判断路由是否存在

```typescript
import { isRouteExist } from '@/utils/router';

const exist = isRouteExist('/system/user');
```

### 服务工具 (src/utils/service.ts)

#### transformRequestData - 转换请求数据

```typescript
import { transformRequestData } from '@/utils/service';

const transformed = transformRequestData(data);
```

#### transformResponseData - 转换响应数据

```typescript
import { transformResponseData } from '@/utils/service';

const transformed = transformResponseData(response);
```

#### handleServiceError - 处理服务错误

```typescript
import { handleServiceError } from '@/utils/service';

handleServiceError(error);
```

### 加密工具 (src/utils/crypto.ts)

#### encryptPassword - 加密密码

```typescript
import { encryptPassword } from '@/utils/crypto';

const encrypted = encryptPassword('password123');
```

#### decryptPassword - 解密密码

```typescript
import { decryptPassword } from '@/utils/crypto';

const decrypted = decryptPassword(encrypted);
```

## Hooks 使用示例

### 1. 表格数据管理

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { useTable } from '@/hooks/common/element-table';
import { fetchUserList } from '@/service/api/system';

const queryForm = ref({
  username: '',
  status: ''
});

const {
  data,
  loading,
  pagination,
  getData,
  handleQuery,
  handleReset
} = useTable({
  apiFn: fetchUserList,
  apiParams: {
    pageNum: 1,
    pageSize: 10
  },
  immediate: true
});

// 查询
function handleSearch() {
  handleQuery(queryForm.value);
}

// 重置
function handleResetForm() {
  queryForm.value = {
    username: '',
    status: ''
  };
  handleReset();
}
</script>

<template>
  <div>
    <!-- 搜索表单 -->
    <el-form :model="queryForm" inline>
      <el-form-item label="用户名">
        <el-input v-model="queryForm.username" />
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleSearch">查询</el-button>
        <el-button @click="handleResetForm">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 表格 -->
    <el-table :data="data" :loading="loading">
      <!-- 表格列 -->
    </el-table>

    <!-- 分页 -->
    <el-pagination
      v-model:current-page="pagination.pageNum"
      v-model:page-size="pagination.pageSize"
      :total="pagination.total"
      @size-change="getData"
      @current-change="getData"
    />
  </div>
</template>
```

### 2. 表单管理

```vue
<script setup lang="ts">
import { ref, reactive } from 'vue';
import type { FormInstance } from 'element-plus';
import { useBoolean, useLoading } from '@sa/hooks';
import { getRequiredRule, getEmailRule } from '@/utils/form';

const formRef = ref<FormInstance>();
const { bool: visible, setTrue: open, setFalse: close } = useBoolean(false);
const { loading, startLoading, endLoading } = useLoading(false);

const formData = reactive({
  username: '',
  email: '',
  status: '0'
});

const rules = {
  username: [getRequiredRule('请输入用户名')],
  email: [getEmailRule('请输入正确的邮箱')]
};

async function handleSubmit() {
  if (!formRef.value) return;
  
  await formRef.value.validate();
  
  startLoading();
  try {
    // 提交数据
    await api.submit(formData);
    close();
  } finally {
    endLoading();
  }
}
</script>

<template>
  <el-dialog v-model="visible" title="表单">
    <el-form
      ref="formRef"
      :model="formData"
      :rules="rules"
      label-width="100px"
    >
      <el-form-item label="用户名" prop="username">
        <el-input v-model="formData.username" />
      </el-form-item>
      <el-form-item label="邮箱" prop="email">
        <el-input v-model="formData.email" />
      </el-form-item>
    </el-form>
    
    <template #footer>
      <el-button @click="close">取消</el-button>
      <el-button type="primary" :loading="loading" @click="handleSubmit">
        确定
      </el-button>
    </template>
  </el-dialog>
</template>
```

### 3. 请求管理

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { useLoading } from '@sa/hooks';
import { fetchUserDetail } from '@/service/api/system';

const { loading, startLoading, endLoading } = useLoading(false);
const userDetail = ref<Api.System.User | null>(null);

async function getUserDetail(id: number) {
  startLoading();
  try {
    const { data } = await fetchUserDetail(id);
    userDetail.value = data;
  } finally {
    endLoading();
  }
}
</script>

<template>
  <div v-loading="loading">
    <div v-if="userDetail">
      <p>用户名: {{ userDetail.username }}</p>
      <p>邮箱: {{ userDetail.email }}</p>
    </div>
  </div>
</template>
```

## 工具函数最佳实践

### 1. 函数命名

- 使用动词开头: `get`, `set`, `fetch`, `handle`, `transform`
- 使用驼峰命名: `getUserInfo`, `handleSubmit`
- 布尔函数使用 `is`, `has`, `can`: `isValid`, `hasPermission`

### 2. 函数参数

```typescript
// 好的做法：使用对象参数
function createUser(options: {
  username: string;
  email: string;
  role?: string;
}) {
  // ...
}

// 避免：过多的位置参数
function createUser(username: string, email: string, role?: string) {
  // ...
}
```

### 3. 函数返回值

```typescript
// 好的做法：明确的返回类型
function getUser(id: number): Promise<User> {
  return api.getUser(id);
}

// 好的做法：返回对象
function validateForm(data: FormData): {
  valid: boolean;
  errors: string[];
} {
  // ...
}
```

### 4. 错误处理

```typescript
// 好的做法：统一的错误处理
async function fetchData() {
  try {
    const data = await api.getData();
    return { data, error: null };
  } catch (error) {
    return { data: null, error };
  }
}
```

### 5. 类型定义

```typescript
// 好的做法：使用 TypeScript 类型
interface User {
  id: number;
  username: string;
  email: string;
}

function getUser(id: number): Promise<User> {
  return api.getUser(id);
}
```

## 自定义工具函数

### 1. 创建工具函数

```typescript
// src/utils/custom.ts

/**
 * 格式化金额
 * @param amount 金额
 * @param decimals 小数位数
 * @returns 格式化后的金额
 */
export function formatAmount(amount: number, decimals = 2): string {
  return amount.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

/**
 * 防抖函数
 * @param fn 函数
 * @param delay 延迟时间
 * @returns 防抖后的函数
 */
export function debounce<T extends (...args: any[]) => any>(
  fn: T,
  delay = 300
): (...args: Parameters<T>) => void {
  let timer: ReturnType<typeof setTimeout> | null = null;
  
  return function (this: any, ...args: Parameters<T>) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, args);
    }, delay);
  };
}

/**
 * 节流函数
 * @param fn 函数
 * @param delay 延迟时间
 * @returns 节流后的函数
 */
export function throttle<T extends (...args: any[]) => any>(
  fn: T,
  delay = 300
): (...args: Parameters<T>) => void {
  let timer: ReturnType<typeof setTimeout> | null = null;
  
  return function (this: any, ...args: Parameters<T>) {
    if (timer) return;
    timer = setTimeout(() => {
      fn.apply(this, args);
      timer = null;
    }, delay);
  };
}
```

### 2. 使用自定义工具函数

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { formatAmount, debounce } from '@/utils/custom';

const amount = ref(1234567.89);
const formattedAmount = formatAmount(amount.value);
// 返回: "1,234,567.89"

// 防抖搜索
const handleSearch = debounce((keyword: string) => {
  console.log('搜索:', keyword);
}, 500);
</script>

<template>
  <div>
    <p>金额: {{ formattedAmount }}</p>
    <el-input @input="handleSearch" />
  </div>
</template>
```

## 下一步

- 查看 [API 接口规范](./04-API接口规范.md)
- 学习 [设计模式](./05-设计模式.md)
- 阅读 [最佳实践](./06-最佳实践.md)
