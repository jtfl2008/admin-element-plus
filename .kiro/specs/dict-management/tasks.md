# 实现计划: 字典管理

## 概述

本实现计划基于字典管理的需求和设计文档，采用树形表格结构展示字典类型和字典数据的层级关系。字典类型作为父节点，字典数据作为子节点。实现将使用 Vue 3 + TypeScript + Element Plus 技术栈，并复用项目已有的 ConfigurableTable、ConfigurableForm、DialogForm 等组件。

## 任务

- [ ] 1. 完善类型定义
  - 在 `src/typings/api/system.d.ts` 中添加字典相关类型定义
  - 定义 DictType、DictData、DictTreeNode 等接口
  - 定义搜索参数和操作参数接口
  - _需求: 1.1, 1.2, 1.3, 7.1, 7.2, 7.3_

- [ ] 2. 实现 API 服务层
  - [ ] 2.1 完善字典类型 API
    - 确认 `src/service/api/system/dict.ts` 中的接口完整性
    - 确保包含获取列表、新增、编辑、删除、刷新缓存、导出等接口
    - _需求: 1.1, 2.4, 3.3, 4.2, 5.1, 6.1_
  
  - [ ] 2.2 完善字典数据 API
    - 确认 `src/service/api/system/dict-data.ts` 中的接口完整性
    - 确保包含根据类型查询、获取列表、新增、编辑、删除、导出等接口
    - _需求: 7.1, 8.5, 9.3, 10.3, 11.1, 16.1, 16.2_

- [ ] 3. 实现工具函数
  - [ ] 3.1 创建树形数据构建函数
    - 在 `src/utils/dict.ts` 中实现 `buildDictTree` 函数
    - 将字典类型和字典数据组合成树形结构
    - 实现字典数据按 dictSort 排序逻辑
    - _需求: 7.1, 13.3, 13.4_
  
  - [ ] 3.2 创建数据加载函数
    - 实现 `loadDictTree` 函数
    - 并行加载字典类型和字典数据
    - 构建完整的树形数据结构
    - _需求: 1.1, 7.1_
  
  - [ ] 3.3 创建表单验证函数
    - 实现 `validateDictTypeForm` 函数
    - 实现 `validateDictDataForm` 函数
    - 验证必填字段、空白字符、字典类型格式等
    - _需求: 2.2, 2.3, 3.2, 8.3, 8.4, 9.2_

- [ ] 4. 实现字典管理主页面
  - [ ] 4.1 创建页面基础结构
    - 创建 `src/views/system/dict/index.vue` 文件
    - 设置页面布局和基础状态管理
    - 初始化响应式数据
    - _需求: 1.1_
  
  - [ ] 4.2 实现搜索表单
    - 使用 ConfigurableForm 组件
    - 配置字典名称、字典类型、状态搜索字段
    - 实现搜索和重置功能
    - _需求: 1.2, 2.1, 2.2, 2.3, 2.4_
  
  - [ ] 4.3 实现树形表格
    - 使用 ConfigurableTable 组件
    - 配置树形表格列（名称/标签、类型/键值、排序、样式、状态、创建时间、操作）
    - 实现自定义插槽渲染不同节点类型
    - 配置工具栏（新增字典类型、刷新缓存、导出、展开/折叠、刷新）
    - _需求: 1.1, 1.3, 7.3, 12.3, 14.4_
  
  - [ ] 4.4 实现数据加载逻辑
    - 页面初始化时加载树形数据
    - 实现 loading 状态管理
    - 处理加载错误
    - _需求: 1.1, 1.4, 7.1, 7.4_
  
  - [ ] 4.5 实现展开/折叠功能
    - 实现展开所有节点功能
    - 实现折叠所有节点功能
    - 管理展开状态
    - _需求: 1.3_

- [ ] 5. 实现字典类型操作功能
  - [ ] 5.1 实现新增字典类型
    - 使用 DialogForm 组件创建新增对话框
    - 配置表单字段（字典名称、字典类型、备注）
    - 配置表单验证规则
    - 实现提交逻辑和成功后刷新
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  
  - [ ] 5.2 实现编辑字典类型
    - 复用 DialogForm 组件
    - 点击编辑时填充当前数据
    - 字典类型字段设置为禁用
    - 实现更新逻辑和成功后刷新
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [ ] 5.3 实现删除字典类型
    - 实现删除前确认对话框
    - 检查是否有子节点（字典数据）
    - 如果有子节点则阻止删除并提示
    - 实现删除逻辑和成功后刷新
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 6. 实现字典数据操作功能
  - [ ] 6.1 实现新增字典数据
    - 使用 DialogForm 组件创建新增对话框
    - 配置表单字段（字典类型、字典标签、字典键值、字典排序、回显样式、CSS样式、是否默认、状态、备注）
    - 字典类型字段自动填充父节点的字典类型且禁用
    - 配置表单验证规则
    - 实现提交逻辑和成功后刷新
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_
  
  - [ ] 6.2 实现编辑字典数据
    - 复用 DialogForm 组件
    - 点击编辑时填充当前数据
    - 字典类型字段设置为禁用
    - 实现更新逻辑和成功后刷新
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_
  
  - [ ] 6.3 实现删除字典数据
    - 实现删除前确认对话框
    - 实现删除逻辑和成功后刷新
    - _需求: 10.2, 10.3, 10.4, 10.5, 10.6_

- [ ] 7. 实现其他功能
  - [ ] 7.1 实现刷新缓存功能
    - 点击刷新缓存按钮调用接口
    - 显示成功或失败提示
    - _需求: 5.1, 5.2, 5.3_
  
  - [ ] 7.2 实现导出功能
    - 实现导出所有字典数据
    - 处理 Blob 数据并触发下载
    - 显示成功或失败提示
    - _需求: 6.1, 6.2, 6.3, 11.1, 11.2, 11.3_
  
  - [ ] 7.3 实现回显样式选择器
    - 在字典数据表单中配置回显样式选择器
    - 提供 primary、success、info、warning、error、default 选项
    - 在列表中正确显示选定的样式
    - _需求: 12.1, 12.2, 12.3, 12.4_
  
  - [ ] 7.4 实现状态管理
    - 在表单中提供状态开关
    - 在列表中以不同样式显示状态
    - 确保禁用状态的数据在选择器中隐藏
    - _需求: 14.1, 14.2, 14.3, 14.4_

- [ ] 8. 实现字典选择器接口
  - [ ] 8.1 确认字典类型选择器接口
    - 确保 `fetchGetDictTypeOptionSelect` 接口可用
    - 返回所有字典类型数组
    - 确保数据一致性
    - _需求: 15.1, 15.2, 15.3_
  
  - [ ] 8.2 确认字典数据查询接口
    - 确保 `fetchGetDictDataByType` 接口可用
    - 只返回启用状态的字典数据
    - 处理字典类型不存在的情况
    - 确保数据一致性
    - _需求: 16.1, 16.2, 16.3, 16.4_

- [ ] 9. 样式和优化
  - [ ] 9.1 添加页面样式
    - 为字典类型节点和字典数据节点添加不同的样式
    - 优化树形表格的视觉效果
    - 确保响应式布局
  
  - [ ] 9.2 性能优化
    - 优化数据加载性能（使用 Promise.all 并行加载）
    - 考虑大数据量时的虚拟滚动
    - 优化树形结构的渲染性能
  
  - [ ] 9.3 错误处理优化
    - 统一错误提示样式
    - 添加友好的错误信息
    - 处理网络错误和业务错误

- [ ] 10. 测试和验证
  - [ ] 10.1 功能测试
    - 测试字典类型的增删改查
    - 测试字典数据的增删改查
    - 测试搜索和筛选功能
    - 测试展开/折叠功能
    - 测试刷新缓存和导出功能
  
  - [ ] 10.2 边缘情况测试
    - 测试空数据状态
    - 测试删除包含字典数据的字典类型
    - 测试表单验证（必填字段、空白字符、格式验证）
    - 测试网络错误处理
  
  - [ ] 10.3 集成测试
    - 测试完整的用户操作流程
    - 测试与其他模块的集成（字典选择器）
    - 测试数据一致性

## 注意事项

1. **树形结构**：确保字典类型作为父节点，字典数据作为子节点，节点 id 使用 `type-${dictId}` 和 `data-${dictCode}` 格式
2. **数据加载**：使用 Promise.all 并行加载字典类型和字典数据以提高性能
3. **删除保护**：删除字典类型前必须检查是否有子节点
4. **表单验证**：字典类型字段只能包含小写字母和下划线
5. **自动填充**：新增字典数据时自动填充父节点的字典类型
6. **排序规则**：字典数据按 dictSort 升序排列，相同时按创建时间排序
7. **状态过滤**：字典选择器接口只返回启用状态的数据
8. **错误处理**：所有 API 调用都需要适当的错误处理和用户提示
