# 菜单管理实现任务列表

## 概述

本任务列表将菜单管理系统的设计转换为可执行的开发任务。任务按照增量方式组织，每个任务都建立在前面任务的基础上，确保功能逐步完善并及时验证。

## 任务

- [x] 1. 创建菜单管理的类型定义和 API 服务
  - 在 `src/typings/api/system.d.ts` 中添加菜单相关的类型定义
  - 创建 `src/service/api/system/menu.ts` 文件，实现所有菜单相关的 API 接口
  - _需求：1.1, 3.6, 4.4, 5.2, 12.2, 13.1, 16.1_

- [x] 2. 实现 handleTree 工具函数
  - [x] 2.1 在 `src/utils` 目录下创建 `tree.ts` 文件
    - 实现 handleTree 函数，将扁平数组转换为树形结构
    - 支持自定义 id、parentId 和 children 字段名
    - _需求：1.2_
  
  - [ ]* 2.2 编写 handleTree 的属性测试
    - **属性 1：树形数据转换的正确性**
    - **验证：需求 1.2**

- [x] 3. 实现菜单树过滤和排序工具函数
  - [x] 3.1 在 `src/utils/tree.ts` 中实现 filterMenuTree 函数
    - 根据菜单类型过滤菜单树
    - 递归处理子菜单
    - _需求：1.5_
  
  - [x] 3.2 在 `src/utils/tree.ts` 中实现 sortMenus 函数
    - 按 orderNum 排序菜单
    - orderNum 相同时按 createTime 排序
    - _需求：11.2, 11.3_
  
  - [ ]* 3.3 编写菜单树过滤的属性测试
    - **属性 2：菜单树过滤的完整性**
    - **验证：需求 1.5**
  
  - [ ]* 3.4 编写菜单排序的属性测试
    - **属性 22：菜单排序的正确性**
    - **验证：需求 11.2, 11.3**

- [x] 4. 实现菜单表单验证函数
  - [x] 4.1 在 `src/utils` 目录下创建 `menu-validation.ts` 文件
    - 实现 validateMenuForm 函数
    - 验证必填字段
    - 验证菜单类型特定的字段（路由地址、组件路径、权限标识）
    - 验证 orderNum 为非负整数
    - 验证外链 URL 格式
    - _需求：15.1, 15.2, 15.3, 15.4, 15.5, 15.7_
  
  - [ ]* 4.2 编写表单验证的属性测试
    - **属性 15：菜单类型路由验证**
    - **属性 16：外链 URL 验证**
    - **属性 25：必填字段验证**
    - **属性 26：按钮类型权限验证**
    - **属性 27：显示顺序验证**
    - **验证：需求 15.1, 15.2, 15.3, 15.4, 15.5, 15.7**

- [x] 5. 创建图标选择器组件
  - [x] 5.1 创建 `src/components/IconSelector/index.vue` 组件
    - 支持 Iconify 图标和本地图标两种类型
    - Iconify 类型显示文本输入框
    - 本地图标类型显示下拉选择框
    - 实时预览选中的图标
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 5.2 创建 `src/components/IconSelector/types.ts` 类型定义文件
    - 定义 IconSelectorProps 和 IconSelectorEmits
    - _需求：6.1_
  
  - [x] 5.3 实现 getLocalMenuIcons 函数
    - 获取本地图标列表
    - _需求：6.6_
  
  - [ ]* 5.4 编写图标选择器的单元测试
    - 测试图标类型切换
    - 测试图标预览功能
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 6. 实现菜单树组件的图标渲染逻辑
  - [x] 6.1 更新 `src/components/MenuTree/index.vue` 组件
    - 实现 renderIcon 函数
    - 根据图标名称前缀判断图标类型
    - 正确渲染 Iconify 图标和本地图标
    - _需求：6.7_
  
  - [ ]* 6.2 编写图标渲染的属性测试
    - **属性 14：图标类型判断的正确性**
    - **验证：需求 6.7**

- [x] 7. 检查点 - 确保工具函数和组件测试通过
  - 确保所有测试通过，如有问题请向用户提问

- [x] 8. 实现菜单列表页面的基础结构
  - [x] 8.1 更新 `src/views/system/menu/index.vue` 页面
    - 创建页面基础布局（查询卡片 + 内容卡片）
    - 定义页面状态（menuTreeData, currentMenu, btnData, searchKeyword 等）
    - 实现 getMeunTree 方法获取菜单树数据
    - 使用 handleTree 转换数据为树形结构
    - 使用 filterMenuTree 过滤掉按钮类型（F）
    - _需求：1.1, 1.2, 1.5_
  
  - [ ]* 8.2 编写菜单列表加载的单元测试
    - 测试页面初始化时加载菜单树
    - 测试菜单树正确过滤按钮类型
    - _需求：1.1, 1.5_

- [x] 9. 实现菜单树展示和交互
  - [x] 9.1 在菜单列表页面添加菜单树组件
    - 使用 el-tree 组件展示菜单树
    - 显示菜单名称、图标、类型和状态
    - 实现 handleClickTree 方法处理节点点击
    - 点击节点时更新 currentMenu 并加载按钮权限列表
    - _需求：1.3, 1.4_
  
  - [ ]* 9.2 编写菜单树交互的属性测试
    - **属性 3：菜单树节点点击更新状态**
    - **验证：需求 1.3**

- [x] 10. 实现菜单搜索功能
  - [x] 10.1 添加搜索表单
    - 使用 ConfigurableForm 组件创建搜索表单
    - 支持按菜单名称搜索
    - 实现 handleSearch 方法
    - 实现搜索重置功能
    - _需求：2.1, 2.3_
  
  - [ ]* 10.2 编写搜索功能的属性测试
    - **属性 3：搜索功能的准确性**
    - **属性 4：搜索重置的完整性**
    - **验证：需求 2.1, 2.3**

- [x] 11. 实现按钮权限列表展示
  - [x] 11.1 添加按钮权限表格
    - 使用 ConfigurableTable 组件展示按钮权限
    - 实现 getBtnMenuList 方法获取按钮列表
    - 显示按钮名称、权限标识、排序和状态
    - _需求：10.1, 10.2_
  
  - [ ]* 11.2 编写按钮权限加载的属性测试
    - **属性 20：按钮权限加载的正确性**
    - **验证：需求 10.1**

- [x] 12. 检查点 - 确保菜单列表页面基础功能正常
  - 确保所有测试通过，如有问题请向用户提问

- [x] 13. 实现菜单新增对话框
  - [x] 13.1 配置 DialogForm 组件用于新增菜单
    - 定义 dialogForm 状态和 dialogSections 配置
    - 根据菜单类型动态显示表单项
    - 目录（M）：显示菜单名称、图标、排序、状态
    - 菜单（C）：显示所有配置项
    - 按钮（F）：显示按钮名称、父菜单、权限标识、排序、状态
    - 集成 IconSelector 组件
    - _需求：3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [x] 13.2 实现 handleAdd 方法
    - 打开新增对话框
    - 初始化表单数据
    - _需求：3.1_
  
  - [x] 13.3 实现 handleDialogConfirm 方法
    - 验证表单数据
    - 调用 fetchCreateMenu API 创建菜单
    - 成功后关闭对话框并刷新菜单列表
    - 失败时显示错误提示
    - _需求：3.6, 3.7, 3.8_
  
  - [ ]* 13.4 编写菜单新增的单元测试
    - 测试对话框打开和关闭
    - 测试表单动态显示逻辑
    - 测试 API 调用
    - _需求：3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [ ]* 13.5 编写菜单类型支持的属性测试
    - **属性 5：菜单类型支持的完整性**
    - **属性 6：菜单创建 API 调用的正确性**
    - **验证：需求 3.2, 3.6**

- [x] 14. 实现菜单编辑对话框
  - [x] 14.1 实现 handleEdit 方法
    - 打开编辑对话框
    - 填充当前菜单数据到表单
    - _需求：4.1_
  
  - [x] 14.2 实现菜单类型切换的动态表单
    - 监听 menuType 变化
    - 动态调整显示的配置项
    - _需求：4.3_
  
  - [x] 14.3 更新 handleDialogConfirm 方法支持编辑
    - 根据操作类型调用不同的 API
    - 编辑时调用 fetchUpdateMenu API
    - _需求：4.4, 4.5, 4.6_
  
  - [ ]* 14.4 编写菜单编辑的属性测试
    - **属性 7：菜单编辑数据填充的正确性**
    - **属性 8：菜单字段可编辑性**
    - **属性 9：菜单类型切换的动态性**
    - **属性 10：菜单更新 API 调用的正确性**
    - **验证：需求 4.1, 4.2, 4.3, 4.4**

- [x] 15. 实现菜单删除功能
  - [x] 15.1 实现 handleDelete 方法
    - 显示确认对话框
    - 检查是否包含子菜单
    - 包含子菜单时阻止删除并提示
    - 调用 fetchDeleteMenu API 删除菜单
    - 成功后刷新菜单列表
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 15.2 编写菜单删除的属性测试
    - **属性 11：菜单删除 API 调用的正确性**
    - **属性 12：子菜单删除保护**
    - **验证：需求 5.2, 5.5**

- [x] 16. 实现按钮权限管理功能
  - [x] 16.1 添加按钮权限的新增、编辑、删除操作
    - 复用菜单操作对话框
    - 按钮类型时自动设置 parentId 为当前选中菜单
    - _需求：10.3, 10.4, 10.5_
  
  - [ ]* 16.2 编写按钮权限关联的属性测试
    - **属性 21：按钮父菜单关联的正确性**
    - **验证：需求 10.5**

- [x] 17. 检查点 - 确保菜单增删改查功能完整
  - 确保所有测试通过，如有问题请向用户提问

- [x] 18. 实现父菜单选择器
  - [x] 18.1 创建父菜单选择组件
    - 调用 fetchGetMenuTreeSelect API 获取菜单树
    - 排除当前编辑的菜单及其子菜单
    - 使用 el-tree-select 组件
    - _需求：12.1, 12.2, 12.3_
  
  - [ ]* 18.2 编写循环引用防护的属性测试
    - **属性 23：循环引用防护**
    - **验证：需求 12.3**

- [x] 19. 实现菜单状态控制
  - [x] 19.1 添加状态切换功能
    - 使用 StatusSwitch 组件控制菜单状态
    - 支持显示状态（visible）和启用状态（status）切换
    - _需求：9.1, 9.2_
  
  - [ ]* 19.2 编写菜单状态的属性测试
    - **属性 18：隐藏菜单的访问性**
    - **属性 19：停用菜单的不可访问性**
    - **验证：需求 9.3, 9.4**

- [x] 20. 完善角色菜单权限关联功能
  - [x] 20.1 更新 MenuTree 组件
    - 实现 getCheckedMenuIds 方法
    - 支持父子联动配置
    - 启用联动时包含半选状态的父节点
    - _需求：13.3, 13.4, 13.5, 13.6_
  
  - [ ]* 20.2 编写角色菜单权限的属性测试
    - **属性 24：角色菜单权限获取的正确性**
    - **验证：需求 13.5, 13.6**

- [ ] 21. 实现租户套餐菜单关联（可选功能）
  - [ ] 21.1 添加租户套餐菜单配置界面
    - 调用 fetchGetTenantPackageMenuTreeSelect API
    - 显示菜单树供选择
    - _需求：16.1, 16.2_
  
  - [ ] 21.2 实现租户菜单过滤逻辑
    - 根据租户套餐过滤可访问菜单
    - _需求：16.4_
  
  - [ ]* 21.3 编写租户菜单过滤的属性测试
    - **属性 28：租户菜单过滤的正确性**
    - **验证：需求 16.4**

- [x] 22. 添加工具栏操作
  - [x] 22.1 配置 ConfigurableTable 的 toolbars
    - 新增按钮（调用 handleAdd）
    - 刷新按钮（调用 refresh）
    - 展开/折叠按钮
    - 根据权限控制按钮可见性
    - _需求：3.1_

- [x] 23. 完善错误处理
  - [x] 23.1 添加 API 错误处理
    - 所有 API 调用添加 try-catch
    - 显示友好的错误提示
    - 可选：添加测试数据作为降级方案
    - _需求：3.8, 4.6, 5.4_
  
  - [x] 23.2 添加业务逻辑错误处理
    - 删除子菜单检查
    - 循环引用检测
    - 权限不足提示
    - _需求：5.5, 12.3_

- [x] 24. 最终检查点 - 完整功能测试
  - 确保所有测试通过，如有问题请向用户提问
  - 手动测试所有用户流程
  - 验证与角色管理的集成

## 注意事项

- 标记 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
