# 部门管理实现任务列表

## 概述

本任务列表将部门管理系统的设计转换为可执行的开发任务。任务按照增量方式组织，每个任务都建立在前面任务的基础上，确保功能逐步完善并及时验证。

## 任务

- [x] 1. 创建部门管理的类型定义和 API 服务
  - 在 `src/typings/api/system.d.ts` 中添加部门相关的类型定义（Dept, DeptSearchParams, DeptOperateParams, DeptTreeNode）
  - 创建 `src/service/api/system/dept.ts` 文件，实现所有部门相关的 API 接口
  - 实现 fetchGetDeptList、fetchGetExcludeDeptList、fetchCreateDept、fetchUpdateDept、fetchDeleteDept、fetchBatchDeleteDept、fetchGetDeptSelect 接口
  - _需求：1.1, 3.3, 4.3, 5.2, 5.6_

- [x] 2. 验证和完善树形工具函数
  - [x] 2.1 验证 `src/utils/tree.ts` 中的 handleTree 函数
    - 确认函数支持自定义 id、parentId 和 children 字段名
    - 确认正确处理根节点（parentId 为 0 或 null）
    - 确认正确建立父子关系
    - _需求：1.1_
  
  - [ ]* 2.2 编写 handleTree 的属性测试
    - **属性 1：树形数据转换的正确性**
    - **验证：需求 1.1**

- [x] 3. 实现部门树过滤和搜索工具函数
  - [x] 3.1 在 `src/utils/tree.ts` 中实现 filterDeptTree 函数
    - 过滤指定部门及其所有子部门
    - 递归处理子部门
    - _需求：4.5, 7.4_
  
  - [x] 3.2 在 `src/utils/tree.ts` 中实现 searchDeptTree 函数
    - 根据关键词搜索部门名称
    - 保留匹配部门的父级路径
    - 保持树形结构
    - _需求：2.1, 2.5_
  
  - [ ]* 3.3 编写部门树过滤的属性测试
    - **属性 16：循环引用防护的正确性**
    - **验证：需求 4.5, 7.4**
  
  - [ ]* 3.4 编写部门搜索的属性测试
    - **属性 5：部门名称搜索的准确性**
    - **属性 9：搜索结果树形结构的保持性**
    - **验证：需求 2.1, 2.5**

- [x] 4. 实现部门表单验证函数
  - [x] 4.1 在 `src/utils` 目录下创建 `dept-validation.ts` 文件
    - 实现 validateDeptForm 函数
    - 验证必填字段（parentId, deptName, orderNum）
    - 验证部门名称长度（2-50字符）
    - 验证排序号为非负整数
    - 验证电话号码格式（可选）
    - 验证邮箱格式（可选）
    - 返回验证结果和错误信息数组
    - _需求：3.2, 3.5, 3.6, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_
  
  - [ ]* 4.2 编写表单验证的属性测试
    - **属性 10：必填字段验证的正确性**
    - **属性 11：电话号码格式验证的正确性**
    - **属性 12：邮箱格式验证的正确性**
    - **属性 29：排序号类型验证的正确性**
    - **属性 30：验证失败时的错误提示**
    - **属性 31：验证失败时的提交阻止**
    - **验证：需求 3.2, 3.5, 3.6, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7**

- [x] 5. 实现循环引用检测函数
  - [x] 5.1 在 `src/utils/dept-validation.ts` 中实现 checkCircularReference 函数
    - 检测父部门是否是当前部门的子孙部门
    - 递归遍历部门树
    - 返回是否存在循环引用
    - _需求：4.5, 7.4_
  
  - [ ]* 5.2 编写循环引用检测的单元测试
    - 测试正常情况（无循环引用）
    - 测试循环引用情况
    - _需求：4.5, 7.4_

- [x] 6. 检查点 - 确保工具函数测试通过
  - 确保所有测试通过，如有问题请向用户提问

- [x] 7. 实现部门列表页面的基础结构
  - [x] 7.1 创建 `src/views/system/dept/index.vue` 页面
    - 创建页面基础布局（查询卡片 + 内容卡片）
    - 定义页面状态（deptTreeData, searchKeyword, statusFilter, dialogVisible, operateType, editingData, isExpandAll, loading）
    - 实现 getDeptTree 方法获取部门树数据
    - 使用 handleTree 转换数据为树形结构
    - _需求：1.1, 1.2_
  
  - [ ]* 7.2 编写部门列表加载的单元测试
    - 测试页面初始化时加载部门树
    - 测试数据正确转换为树形结构
    - _需求：1.1_

- [x] 8. 实现部门树表格展示
  - [x] 8.1 在部门列表页面添加 ConfigurableTable 组件
    - 配置表格列（部门名称、排序、状态、负责人、联系电话、邮箱、创建时间、操作）
    - 设置 row-key 为 "deptId"
    - 设置 tree-props 支持树形展示
    - 设置 default-expand-all 控制展开状态
    - 状态列使用插槽显示 el-tag
    - _需求：1.2, 1.4, 6.1, 6.2_
  
  - [ ]* 8.2 编写表格列显示的属性测试
    - **属性 2：表格列显示的完整性**
    - **验证：需求 1.2**

- [x] 9. 实现展开/折叠功能
  - [x] 9.1 添加展开/折叠所有节点按钮
    - 在工具栏添加展开/折叠按钮
    - 实现 handleExpandAll 方法
    - 切换 isExpandAll 状态
    - 更新表格的 default-expand-all 属性
    - _需求：1.3_
  
  - [ ]* 9.2 编写展开折叠的属性测试
    - **属性 3：展开折叠操作的正确性**
    - **验证：需求 1.3**

- [x] 10. 实现部门排序
  - [x] 10.1 对部门数据进行排序
    - 使用 sortMenus 工具函数（已存在于 tree.ts）
    - 按 orderNum 升序排序
    - _需求：1.5_
  
  - [ ]* 10.2 编写部门排序的属性测试
    - **属性 4：部门排序的正确性**
    - **验证：需求 1.5**

- [x] 11. 实现部门搜索功能
  - [x] 11.1 添加搜索表单
    - 使用 ConfigurableForm 组件创建搜索表单
    - 添加部门名称输入框
    - 添加状态下拉选择框
    - 实现 handleQuery 方法
    - 使用 searchDeptTree 函数搜索部门
    - 支持按状态筛选
    - 实现 handleReset 方法重置搜索
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 11.2 编写搜索功能的属性测试
    - **属性 5：部门名称搜索的准确性**
    - **属性 6：状态筛选的准确性**
    - **属性 7：组合搜索的准确性**
    - **属性 8：搜索重置的完整性**
    - **属性 9：搜索结果树形结构的保持性**
    - **验证：需求 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 12. 检查点 - 确保部门列表页面基础功能正常
  - 确保所有测试通过，如有问题请向用户提问

- [x] 13. 实现部门新增对话框
  - [x] 13.1 配置 DialogForm 组件用于新增部门
    - 定义 dialogForm 状态和 dialogSections 配置
    - 添加上级部门选择（el-tree-select）
    - 添加部门名称输入框
    - 添加显示顺序输入框（input-number）
    - 添加负责人输入框
    - 添加联系电话输入框
    - 添加邮箱输入框
    - 添加部门状态单选框（正常/停用）
    - 添加备注文本域
    - 配置表单验证规则
    - _需求：3.1, 3.2, 3.5, 3.6, 3.7, 3.8_
  
  - [x] 13.2 实现 handleAddDept 方法
    - 打开新增对话框
    - 初始化表单数据
    - 如果传入父部门，设置 parentId
    - _需求：3.1_
  
  - [x] 13.3 实现 handleDialogConfirm 方法
    - 验证表单数据（调用 validateDeptForm）
    - 验证通过后调用 fetchCreateDept API
    - 成功后关闭对话框并刷新部门列表
    - 失败时显示错误提示
    - _需求：3.3, 3.4, 9.7_
  
  - [ ]* 13.4 编写部门新增的单元测试
    - 测试对话框打开和关闭
    - 测试表单验证
    - 测试 API 调用
    - _需求：3.1, 3.2, 3.3, 3.4_
  
  - [ ]* 13.5 编写部门创建的属性测试
    - **属性 13：部门创建 API 调用的正确性**
    - **验证：需求 3.3**

- [x] 14. 实现上级部门选择器
  - [x] 14.1 实现获取上级部门选项的方法
    - 创建 getParentDeptOptions 方法
    - 新增模式：返回所有部门（转换为树形选择器格式）
    - 编辑模式：排除当前部门及其所有子部门
    - 使用 filterDeptTree 函数过滤
    - 转换为 TreeSelectNode 格式
    - _需求：3.7, 4.5, 7.1, 7.2, 7.3, 7.4_
  
  - [ ]* 14.2 编写上级部门选择的属性测试
    - **属性 16：循环引用防护的正确性**
    - **属性 24：上级部门选择器树形结构的正确性**
    - **属性 25：上级部门选择的正确性**
    - **验证：需求 4.5, 7.2, 7.3, 7.4**

- [x] 15. 实现部门编辑对话框
  - [x] 15.1 实现 handleUpdateDept 方法
    - 打开编辑对话框
    - 填充当前部门数据到表单
    - 获取排除当前部门的上级部门选项
    - _需求：4.1, 4.5_
  
  - [x] 15.2 更新 handleDialogConfirm 方法支持编辑
    - 根据操作类型调用不同的 API
    - 编辑时调用 fetchUpdateDept API
    - 检测循环引用（调用 checkCircularReference）
    - _需求：4.2, 4.3, 4.4, 4.5_
  
  - [ ]* 15.3 编写部门编辑的属性测试
    - **属性 14：部门编辑数据填充的正确性**
    - **属性 15：部门更新 API 调用的正确性**
    - **验证：需求 4.1, 4.3**

- [x] 16. 实现部门删除功能
  - [x] 16.1 实现 handleDeleteDept 方法
    - 显示确认对话框
    - 检查是否包含子部门
    - 包含子部门时阻止删除并提示
    - 调用 fetchDeleteDept API 删除部门
    - 成功后刷新部门列表
    - 处理后端返回的错误（如部门下有用户）
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 16.2 编写部门删除的属性测试
    - **属性 17：部门删除 API 调用的正确性**
    - **属性 18：子部门删除保护**
    - **验证：需求 5.2, 5.4**

- [ ] 17. 实现批量删除功能
  - [ ] 17.1 添加批量删除支持
    - 在 ConfigurableTable 中启用 selection
    - 添加批量删除按钮到工具栏
    - 实现 handleBatchDelete 方法
    - 检查选中的部门是否包含子部门
    - 调用 fetchBatchDeleteDept API
    - _需求：5.6_
  
  - [ ]* 17.2 编写批量删除的属性测试
    - **属性 19：批量删除 API 调用的正确性**
    - **验证：需求 5.6**

- [x] 18. 检查点 - 确保部门增删改查功能完整
  - 确保所有测试通过，如有问题请向用户提问

- [x] 19. 实现部门状态管理
  - [x] 19.1 添加状态显示和切换
    - 在表格状态列使用 el-tag 显示状态
    - 正常状态显示绿色 success 标签
    - 停用状态显示红色 danger 标签
    - 可选：添加状态切换开关（StatusSwitch 组件）
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 19.2 编写部门状态的属性测试
    - **属性 20：正常状态显示的正确性**
    - **属性 21：停用状态显示的正确性**
    - **属性 22：状态更新 API 调用的正确性**
    - **属性 23：停用部门的可见性**
    - **验证：需求 6.1, 6.2, 6.3, 6.4**

- [x] 20. 添加工具栏操作
  - [x] 20.1 配置 ConfigurableTable 的 toolbars
    - 新增按钮（调用 handleAddDept）
    - 批量删除按钮（调用 handleBatchDelete）
    - 展开/折叠按钮（调用 handleExpandAll）
    - 刷新按钮（调用 refresh）
    - 根据权限控制按钮可见性（system:dept:add, system:dept:remove）
    - _需求：3.1, 5.6, 8.1, 8.2, 8.3_
  
  - [ ]* 20.2 编写权限控制的属性测试
    - **属性 26：新增按钮权限控制的正确性**
    - **属性 27：编辑按钮权限控制的正确性**
    - **属性 28：删除按钮权限控制的正确性**
    - **验证：需求 8.1, 8.2, 8.3**

- [x] 21. 完善错误处理
  - [x] 21.1 添加 API 错误处理
    - 所有 API 调用添加 try-catch
    - 显示友好的错误提示
    - 网络错误、权限错误、业务错误分别处理
    - _需求：3.4, 4.4, 5.3_
  
  - [x] 21.2 添加业务逻辑错误处理
    - 删除子部门检查
    - 循环引用检测
    - 权限不足提示
    - 部门下有用户的错误处理
    - _需求：5.4, 5.5, 4.5_

- [x] 22. 优化用户体验
  - [x] 22.1 添加加载状态
    - 列表加载时显示 loading
    - 对话框提交时显示 loading
    - 删除操作时显示 loading
    - _需求：12.1_
  
  - [x] 22.2 添加操作反馈
    - 操作成功显示成功提示
    - 操作失败显示错误提示
    - 删除前显示确认对话框
    - _需求：3.4, 4.4, 5.1, 5.3_

- [ ] 23. 国际化支持（可选）
  - [ ] 23.1 添加中文翻译
    - 在 `src/locales/langs/zh-cn.ts` 中添加部门管理相关的翻译
    - 字段标签、按钮文本、验证消息、状态标签
    - _需求：10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  
  - [ ] 23.2 添加英文翻译
    - 在 `src/locales/langs/en-us.ts` 中添加对应的英文翻译
    - _需求：10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  
  - [ ] 23.3 使用 i18n 函数
    - 所有文本使用 $t 函数
    - 确保语言切换正常工作
    - _需求：10.2_

- [ ] 24. 响应式布局优化（可选）
  - [ ] 24.1 优化移动端显示
    - 调整表格列在小屏幕上的显示
    - 确保对话框在移动端正常显示
    - 确保树形选择器在移动端可用
    - _需求：11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 25. 性能优化（可选）
  - [ ] 25.1 添加性能优化
    - 搜索输入使用防抖（debounce）
    - 考虑虚拟滚动（大量数据时）
    - 缓存部门树数据
    - _需求：12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 26. 最终检查点 - 完整功能测试
  - 确保所有测试通过，如有问题请向用户提问
  - 手动测试所有用户流程
  - 验证与用户管理、角色管理的集成

## 注意事项

- 标记 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 国际化、响应式布局和性能优化为可选任务，可根据项目需求决定是否实现
