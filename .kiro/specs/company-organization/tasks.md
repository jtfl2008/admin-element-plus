# 公司管理实现任务列表

## 概述

本任务列表将公司管理系统的设计转换为可执行的开发任务。任务按照增量方式组织，每个任务都建立在前面任务的基础上，确保功能逐步完善并及时验证。公司管理是企业权限管理系统的核心基础功能，支持多级公司组织架构、层级路径管理和权限控制。

## 任务

- [x] 1. 创建公司管理的类型定义和 API 服务 ✅
  - 在 `src/typings/api/system.d.ts` 中添加公司相关的类型定义（Company, CompanySearchParams, CompanyOperateParams, CompanyTree）
  - 创建 `src/service/api/system/company.ts` 文件，实现所有公司相关的 API 接口
  - 实现 fetchGetCompanyList、fetchGetExcludeCompanyList、fetchCreateCompany、fetchUpdateCompany、fetchDeleteCompany、fetchBatchDeleteCompany、fetchGetCompanySelect、fetchExportCompany 接口
  - _需求：1.1, 3.3, 4.3, 5.2, 5.7, 13.1_

- [ ] 2. 验证和完善树形工具函数
  - [ ] 2.1 验证 `src/utils/tree.ts` 中的 handleTree 函数
    - 确认函数支持自定义 id、parentId 和 children 字段名
    - 确认正确处理根节点（parentId 为 0 或 null）
    - 确认正确建立父子关系
    - _需求：1.1_
  
  - [ ]* 2.2 编写 handleTree 的属性测试
    - **属性 1：树形数据结构的正确性**
    - **验证：需求 1.1**

- [ ] 3. 实现公司树过滤和搜索工具函数
  - [ ] 3.1 在 `src/utils/tree.ts` 中实现 filterCompanyTree 函数
    - 过滤指定公司及其所有子公司
    - 递归处理子公司
    - _需求：4.5, 7.4_
  
  - [ ] 3.2 在 `src/utils/tree.ts` 中实现 searchCompanyTree 函数
    - 根据关键词搜索公司名称和公司编码
    - 保留匹配公司的父级路径
    - 保持树形结构
    - _需求：2.1, 2.2, 2.6_
  
  - [ ]* 3.3 编写公司树过滤的属性测试
    - **属性 10：循环引用防护的正确性**
    - **验证：需求 4.5, 7.4**
  
  - [ ]* 3.4 编写公司搜索的属性测试
    - **属性 4：公司名称搜索的准确性**
    - **属性 5：公司编码搜索的准确性**
    - **验证：需求 2.1, 2.2**


- [ ] 4. 实现公司表单验证函数
  - [ ] 4.1 在 `src/utils` 目录下创建 `company-validation.ts` 文件
    - 实现 validateCompanyForm 函数
    - 验证必填字段（parentId, companyCode, companyName, orderNum）
    - 验证公司编码长度（2-32字符）
    - 验证公司名称长度（2-90字符）
    - 验证公司简称长度（最大30字符）
    - 验证排序号为非负整数
    - 验证电话号码格式（可选）
    - 验证邮箱格式（可选）
    - 返回验证结果和错误信息数组
    - _需求：3.2, 3.6, 3.7, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 10.10_
  
  - [ ]* 4.2 编写表单验证的属性测试
    - **属性 7：必填字段验证的正确性**
    - **属性 15：电话号码格式验证的正确性**
    - **属性 16：邮箱格式验证的正确性**
    - **验证：需求 3.2, 3.6, 3.7, 10.1-10.10**

- [ ] 5. 实现公司路径管理函数
  - [ ] 5.1 在 `src/utils/company-validation.ts` 中实现 generateCompanyPath 函数
    - 根据父公司路径和公司编码生成完整路径
    - 路径格式：父路径.编码（编码补齐到6位）
    - 根公司路径直接使用编码
    - _需求：3.4, 8.1_
  
  - [ ] 5.2 在 `src/utils/company-validation.ts` 中实现 updateCompanyPaths 函数
    - 更新公司及所有子公司的路径
    - 递归处理子公司
    - _需求：4.6, 8.2_
  
  - [ ]* 5.3 编写路径管理的属性测试
    - **属性 8：公司路径生成的正确性**
    - **属性 11：公司路径更新的正确性**
    - **验证：需求 3.4, 4.6, 8.1, 8.2**

- [ ] 6. 实现循环引用检测函数
  - [ ] 6.1 在 `src/utils/company-validation.ts` 中实现 checkCircularReference 函数
    - 检测父公司是否是当前公司的子孙公司
    - 递归遍历公司树
    - 返回是否存在循环引用
    - _需求：4.5, 7.4_
  
  - [ ]* 6.2 编写循环引用检测的单元测试
    - 测试正常情况（无循环引用）
    - 测试循环引用情况
    - _需求：4.5, 7.4_

- [ ] 7. 检查点 - 确保工具函数测试通过
  - 确保所有测试通过，如有问题请向用户提问

- [ ] 8. 实现公司列表页面的基础结构
  - [ ] 8.1 创建 `src/views/system/company/index.vue` 页面
    - 创建页面基础布局（查询卡片 + 内容卡片）
    - 定义页面状态（companyTreeData, searchKeyword, statusFilter, dialogVisible, operateType, editingData, isExpandAll, loading）
    - 实现 getCompanyTree 方法获取公司树数据
    - 使用 handleTree 转换数据为树形结构
    - _需求：1.1, 1.2_
  
  - [ ]* 8.2 编写公司列表加载的单元测试
    - 测试页面初始化时加载公司树
    - 测试数据正确转换为树形结构
    - _需求：1.1_

- [ ] 9. 实现公司树表格展示
  - [ ] 9.1 在公司列表页面添加 ConfigurableTable 组件
    - 配置表格列（公司名称、公司编码、简称、排序、状态、负责人、联系电话、创建时间、操作）
    - 设置 row-key 为 "companyId"
    - 设置 tree-props 支持树形展示
    - 设置 default-expand-all 控制展开状态
    - 状态列使用插槽显示 el-tag
    - _需求：1.2, 1.4, 6.1, 6.2_
  
  - [ ]* 9.2 编写表格列显示的属性测试
    - **属性 2：表格列显示的完整性**
    - **验证：需求 1.2**

- [ ] 10. 实现展开/折叠功能
  - [ ] 10.1 添加展开/折叠所有节点按钮
    - 在工具栏添加展开/折叠按钮
    - 实现 handleExpandAll 方法
    - 切换 isExpandAll 状态
    - 更新表格的 default-expand-all 属性
    - _需求：1.3_
  
  - [ ]* 10.2 编写展开折叠的单元测试
    - 测试展开所有节点
    - 测试折叠所有节点
    - _需求：1.3_

- [ ] 11. 实现公司排序
  - [ ] 11.1 对公司数据进行排序
    - 使用 sortMenus 工具函数（已存在于 tree.ts）
    - 按 orderNum 升序排序
    - _需求：1.5_
  
  - [ ]* 11.2 编写公司排序的属性测试
    - **属性 3：公司排序的正确性**
    - **验证：需求 1.5**

- [ ] 12. 实现公司搜索功能
  - [ ] 12.1 添加搜索表单
    - 使用 ConfigurableForm 组件创建搜索表单
    - 添加公司名称输入框
    - 添加公司编码输入框
    - 添加状态下拉选择框
    - 实现 handleQuery 方法
    - 使用 searchCompanyTree 函数搜索公司
    - 支持按状态筛选
    - 实现 handleReset 方法重置搜索
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  
  - [ ]* 12.2 编写搜索功能的属性测试
    - **属性 4：公司名称搜索的准确性**
    - **属性 5：公司编码搜索的准确性**
    - **属性 6：状态筛选的准确性**
    - **验证：需求 2.1, 2.2, 2.3**

- [ ] 13. 检查点 - 确保公司列表页面基础功能正常
  - 确保所有测试通过，如有问题请向用户提问


- [ ] 14. 实现公司新增对话框
  - [ ] 14.1 配置 DialogForm 组件用于新增公司
    - 定义 dialogForm 状态和 dialogSections 配置
    - 添加上级公司选择（el-tree-select）
    - 添加公司编码输入框
    - 添加公司名称输入框
    - 添加公司简称输入框
    - 添加显示顺序输入框（input-number）
    - 添加负责人输入框
    - 添加联系电话输入框
    - 添加邮箱输入框
    - 添加详细地址输入框
    - 添加公司状态单选框（正常/停用）
    - 添加备注文本域
    - 配置表单验证规则
    - _需求：3.1, 3.2, 3.6, 3.7, 3.8, 3.9_
  
  - [ ] 14.2 实现 handleAddCompany 方法
    - 打开新增对话框
    - 初始化表单数据
    - 如果传入父公司，设置 parentId
    - _需求：3.1_
  
  - [ ] 14.3 实现 handleDialogConfirm 方法
    - 验证表单数据（调用 validateCompanyForm）
    - 验证公司编码唯一性
    - 验证通过后调用 fetchCreateCompany API
    - 后端自动生成公司层级路径
    - 成功后关闭对话框并刷新公司列表
    - 失败时显示错误提示
    - _需求：3.3, 3.4, 3.5, 3.10, 10.10_
  
  - [ ]* 14.4 编写公司新增的单元测试
    - 测试对话框打开和关闭
    - 测试表单验证
    - 测试 API 调用
    - _需求：3.1, 3.2, 3.3, 3.4_
  
  - [ ]* 14.5 编写公司创建的属性测试
    - **属性 8：公司路径生成的正确性**
    - **属性 9：公司编码唯一性验证**
    - **验证：需求 3.4, 3.10**

- [ ] 15. 实现上级公司选择器
  - [ ] 15.1 实现获取上级公司选项的方法
    - 创建 getParentCompanyOptions 方法
    - 新增模式：返回所有公司（转换为树形选择器格式）
    - 编辑模式：排除当前公司及其所有子公司
    - 使用 filterCompanyTree 函数过滤
    - 转换为 TreeSelectNode 格式
    - _需求：3.8, 4.5, 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ]* 15.2 编写上级公司选择的属性测试
    - **属性 10：循环引用防护的正确性**
    - **验证：需求 4.5, 7.2, 7.3, 7.4**

- [ ] 16. 实现公司编辑对话框
  - [ ] 16.1 实现 handleUpdateCompany 方法
    - 打开编辑对话框
    - 填充当前公司数据到表单
    - 获取排除当前公司的上级公司选项
    - _需求：4.1, 4.5_
  
  - [ ] 16.2 更新 handleDialogConfirm 方法支持编辑
    - 根据操作类型调用不同的 API
    - 编辑时调用 fetchUpdateCompany API
    - 检测循环引用（调用 checkCircularReference）
    - 如果修改了上级公司，重新计算层级路径
    - 验证修改后的公司编码唯一性（排除自身）
    - _需求：4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.9_
  
  - [ ]* 16.3 编写公司编辑的属性测试
    - **属性 11：公司路径更新的正确性**
    - **验证：需求 4.6**

- [ ] 17. 实现公司删除功能
  - [ ] 17.1 实现 handleDeleteCompany 方法
    - 显示确认对话框
    - 检查是否包含子公司
    - 包含子公司时阻止删除并提示
    - 调用 fetchDeleteCompany API 删除公司
    - 成功后刷新公司列表
    - 处理后端返回的错误（如公司下有部门或用户）
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5, 5.6_
  
  - [ ]* 17.2 编写公司删除的属性测试
    - **属性 12：子公司删除保护**
    - **验证：需求 5.4**

- [ ] 18. 实现批量删除功能
  - [ ] 18.1 添加批量删除支持
    - 在 ConfigurableTable 中启用 selection
    - 添加批量删除按钮到工具栏
    - 实现 handleBatchDelete 方法
    - 检查选中的公司是否包含子公司
    - 调用 fetchBatchDeleteCompany API
    - _需求：5.7_
  
  - [ ]* 18.2 编写批量删除的单元测试
    - 测试批量删除逻辑
    - 测试子公司检查
    - _需求：5.7_

- [ ] 19. 检查点 - 确保公司增删改查功能完整
  - 确保所有测试通过，如有问题请向用户提问

- [ ] 20. 实现公司状态管理
  - [ ] 20.1 添加状态显示和切换
    - 在表格状态列使用 el-tag 显示状态
    - 正常状态显示绿色 success 标签
    - 停用状态显示红色 danger 标签
    - 可选：添加状态切换开关（StatusSwitch 组件）
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 20.2 编写公司状态的属性测试
    - **属性 13：正常状态显示的正确性**
    - **属性 14：停用状态显示的正确性**
    - **验证：需求 6.1, 6.2**

- [ ] 21. 实现数据导出功能
  - [ ] 21.1 添加导出按钮和逻辑
    - 在工具栏添加导出按钮
    - 实现 handleExport 方法
    - 调用 fetchExportCompany API
    - 传递当前搜索条件
    - 触发文件下载
    - 显示成功/失败提示
    - _需求：13.1, 13.2, 13.3, 13.4, 13.5_
  
  - [ ]* 21.2 编写导出功能的单元测试
    - 测试导出参数传递
    - 测试文件下载触发
    - _需求：13.1-13.5_

- [ ] 22. 添加工具栏操作
  - [ ] 22.1 配置 ConfigurableTable 的 toolbars
    - 新增按钮（调用 handleAddCompany）
    - 批量删除按钮（调用 handleBatchDelete）
    - 展开/折叠按钮（调用 handleExpandAll）
    - 导出按钮（调用 handleExport）
    - 刷新按钮（调用 refresh）
    - 根据权限控制按钮可见性（system:company:add, system:company:remove, system:company:export）
    - _需求：3.1, 5.7, 9.1, 9.2, 9.3, 13.1_
  
  - [ ]* 22.2 编写权限控制的单元测试
    - 测试按钮可见性
    - 测试按钮禁用状态
    - _需求：9.1, 9.2, 9.3_

- [ ] 23. 完善错误处理
  - [ ] 23.1 添加 API 错误处理
    - 所有 API 调用添加 try-catch
    - 显示友好的错误提示
    - 网络错误、权限错误、业务错误分别处理
    - _需求：3.5, 4.4, 5.3_
  
  - [ ] 23.2 添加业务逻辑错误处理
    - 删除子公司检查
    - 删除包含部门的公司检查
    - 删除包含用户的公司检查
    - 循环引用检测
    - 公司编码重复检查
    - 权限不足提示
    - _需求：5.4, 5.5, 5.6, 4.5, 3.10_

- [ ] 24. 优化用户体验
  - [ ] 24.1 添加加载状态
    - 列表加载时显示 loading
    - 对话框提交时显示 loading
    - 删除操作时显示 loading
    - 导出操作时显示 loading
    - _需求：14.1_
  
  - [ ] 24.2 添加操作反馈
    - 操作成功显示成功提示
    - 操作失败显示错误提示
    - 删除前显示确认对话框
    - _需求：3.5, 4.4, 5.1, 5.3_

- [ ] 25. 性能优化
  - [ ] 25.1 添加性能优化
    - 搜索输入使用防抖（debounce）
    - 考虑虚拟滚动（大量数据时）
    - 缓存公司树数据
    - 通过公司路径字段优化查询性能
    - _需求：14.1, 14.2, 14.3, 14.4, 14.5, 14.6_

- [ ] 26. 最终检查点 - 完整功能测试
  - 确保所有测试通过，如有问题请向用户提问
  - 手动测试所有用户流程
  - 验证与部门管理、用户管理的集成
  - 验证公司层级路径的正确性
  - 验证循环引用防护的有效性

## 注意事项

- 标记 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 公司层级路径管理是核心特性，需要特别关注
- 循环引用防护是关键安全特性，必须正确实现
- 性能优化任务可根据实际数据量决定是否实施

