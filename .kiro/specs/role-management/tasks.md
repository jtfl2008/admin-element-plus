# 实现计划: 角色管理

## 概述

本实现计划将角色管理模块的设计转化为可执行的编码任务。每个任务都是离散的、可管理的步骤，按照增量方式构建功能，并通过代码尽早验证核心功能。

## 任务

- [x] 1. 创建角色管理 API 接口
  - 在 `src/service/api/system/role.ts` 中定义所有角色相关的 API 接口
  - 包括：获取角色列表、创建角色、更新角色、删除角色、更新状态、获取菜单树、获取部门树、配置数据权限、用户分配等接口
  - _需求: 1.1, 2.8, 3.4, 4.2, 5.2, 6.8, 7.3, 7.4, 8.1_

- [x] 2. 定义角色相关类型
  - 在 `src/typings/api/system.d.ts` 中定义角色相关的 TypeScript 类型
  - 包括：RoleSearchParams, Role, RoleOperateParams, DataScopeParams, RoleMenuTree, RoleDeptTree, RoleUserSearchParams 等
  - _需求: 所有需求_

- [x] 3. 创建菜单权限树组件
  - [x] 3.1 创建 MenuTree 组件基础结构
    - 在 `src/components/MenuTree/index.vue` 中创建组件
    - 实现 v-model 双向绑定（menuIds 数组）
    - 接收 roleId prop 用于获取已选菜单
    - _需求: 12.1, 12.2_
  
  - [x] 3.2 实现菜单树数据加载和渲染
    - 调用 API 获取菜单树数据
    - 使用 el-tree 组件渲染菜单树
    - 支持展开/折叠、全选/全不选功能
    - _需求: 12.2, 12.3, 12.4_
  
  - [x] 3.3 实现菜单树父子联动
    - 勾选父节点时自动勾选所有子节点
    - 取消勾选父节点时自动取消勾选所有子节点
    - _需求: 12.5, 12.6_
  
  - [x] 3.4 实现已选菜单回显
    - 编辑角色时显示该角色已选中的菜单权限
    - _需求: 12.7_

- [x] 4. 创建部门权限树组件
  - [x] 4.1 创建 DeptTree 组件基础结构
    - 在 `src/components/DeptTree/index.vue` 中创建组件
    - 实现 v-model 双向绑定（deptIds 数组）
    - 接收 roleId prop 用于获取已选部门
    - _需求: 13.1, 13.2_
  
  - [x] 4.2 实现部门树数据加载和渲染
    - 调用 API 获取部门树数据
    - 使用 el-tree 组件渲染部门树
    - 支持展开/折叠、全选/全不选功能
    - _需求: 13.2, 13.3, 13.4_
  
  - [x] 4.3 实现部门树父子联动
    - 勾选父部门时自动勾选所有子部门
    - 取消勾选父部门时自动取消勾选所有子部门
    - _需求: 13.5, 13.6_
  
  - [x] 4.4 实现已选部门回显
    - 编辑数据权限时显示该角色已选中的部门
    - _需求: 13.7_

- [x] 5. 创建状态切换组件
  - 在 `src/components/StatusSwitch/index.vue` 中创建组件
  - 封装 el-switch，添加切换前确认功能
  - 实现 v-model 双向绑定
  - 支持 disabled 和 loading 状态
  - _需求: 5.1, 5.2_

- [x] 6. 实现角色管理主页面基础结构
  - [x] 6.1 创建页面文件和基础布局
    - 在 `src/views/system/role/index.vue` 中创建页面
    - 导入必要的组件和工具
    - 设置页面基础结构
    - _需求: 1.1_
  
  - [x] 6.2 配置查询表单
    - 使用 ConfigurableForm 组件
    - 配置查询字段：角色名称、权限字符、状态、创建时间
    - 实现查询和重置功能
    - _需求: 1.2, 1.3, 1.4, 1.5_
  
  - [x] 6.3 配置数据表格
    - 使用 ConfigurableTable 组件
    - 配置表格列：角色名称、权限字符、显示顺序、数据范围、状态、创建时间、操作
    - 配置工具栏按钮：新增、批量删除、导出、刷新
    - _需求: 1.1, 1.6, 9.2_
  
  - [x] 6.4 实现表格数据加载
    - 使用 useTable 工具管理表格数据
    - 实现 getTableData 函数调用角色列表 API
    - 实现分页功能
    - _需求: 1.1, 1.6_

- [x] 7. 实现角色 CRUD 操作
  - [x] 7.1 实现新增角色功能
    - 配置角色操作对话框（DialogForm）
    - 配置表单字段和验证规则
    - 集成 MenuTree 组件选择菜单权限
    - 实现表单提交和数据保存
    - _需求: 2.1, 2.2, 2.3, 2.5, 2.6, 2.8, 2.9_
  
  - [x] 7.2 实现编辑角色功能
    - 点击编辑按钮获取角色详情
    - 填充表单数据和已选菜单权限
    - 实现表单提交和数据更新
    - _需求: 3.1, 3.3, 3.4, 3.5_
  
  - [x] 7.3 实现删除角色功能
    - 实现单个删除功能（带确认对话框）
    - 实现批量删除功能
    - 保护超级管理员角色（roleId=1）不可删除
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [x] 7.4 实现角色状态切换
    - 使用 StatusSwitch 组件
    - 实现状态切换前确认
    - 实现状态更新 API 调用
    - 处理切换失败时恢复原状态
    - _需求: 5.2, 5.3, 5.4_

- [x] 8. 实现数据权限配置功能
  - [x] 8.1 创建数据权限配置对话框
    - 使用 DialogForm 组件
    - 配置数据范围单选项
    - 集成 DeptTree 组件（仅自定义数据权限时显示）
    - _需求: 6.1, 6.2, 6.4_
  
  - [x] 8.2 实现数据权限保存
    - 实现表单提交
    - 调用数据权限配置 API
    - 刷新角色列表显示最新数据范围
    - _需求: 6.8_

- [x] 9. 实现用户分配功能
  - [x] 9.1 创建用户分配对话框
    - 使用 DialogForm 组件
    - 使用自定义插槽渲染用户列表
    - 配置用户搜索表单
    - 配置用户表格
    - _需求: 7.1, 7.2_
  
  - [x] 9.2 实现已分配用户列表
    - 加载已分配用户数据
    - 实现搜索和分页功能
    - 实现取消授权功能
    - _需求: 7.2, 7.4_
  
  - [x] 9.3 实现添加用户功能
    - 创建用户选择对话框
    - 加载未分配用户列表
    - 实现批量添加用户
    - _需求: 7.3_

- [x] 10. 实现导出功能
  - 实现导出按钮点击事件
  - 调用导出 API 并传递筛选条件
  - 处理文件下载
  - _需求: 8.1, 8.2, 8.3_

- [x] 11. 实现权限控制
  - 使用 useAuth hook 获取权限判断函数
  - 为所有操作按钮添加权限控制
  - 权限码：system:role:list, system:role:add, system:role:edit, system:role:remove, system:role:export
  - _需求: 所有需求_

- [x] 12. 实现数据范围标签显示
  - 创建数据范围映射记录
  - 实现 getDataScopeLabel 函数
  - 实现 getDataScopeTagType 函数
  - 在表格中使用插槽渲染数据范围标签
  - _需求: 1.1_

- [x] 13. 实现批量删除按钮状态控制
  - 监听表格选择变化
  - 根据选中行数量控制批量删除按钮的启用/禁用状态
  - _需求: 9.3, 9.4_

- [x] 14. 实现错误处理和用户提示
  - 为所有 API 调用添加 try-catch 错误处理
  - 使用 ElMessage 显示成功/失败提示
  - 实现状态切换失败时恢复原状态
  - _需求: 5.3, 5.4_

- [x] 15. 添加路由配置
  - 在路由文件中添加角色管理页面路由
  - 配置路由元信息（标题、图标、权限等）
  - _需求: 1.1_

- [x] 16. 最终检查点
  - 确保所有功能正常工作
  - 确保所有必填项验证生效
  - 确保权限控制正确
  - 确保超级管理员保护生效
  - 如有问题，询问用户

## 注意事项

- 任务标记 `*` 的为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 实现时应参考设计文档中的详细配置和代码示例
- 所有对话框都使用 DialogForm 组件，不使用 el-drawer
- 自定义组件（MenuTree、DeptTree）直接作为 component 传入字段配置
- 超级管理员角色（roleId=1）需要特殊保护，不可删除、不可禁用
